<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://jsweeta.github.io/blogs/blogs/Vue%E6%BA%90%E7%A0%81/%E5%93%8D%E5%BA%94%E5%BC%8F%E8%AE%BE%E8%AE%A1%E5%92%8C%E6%B8%B2%E6%9F%93%E5%99%A8.html"><meta property="og:title" content="响应式设计和渲染器设计"><meta property="og:description" content="针对Vue3源码里响应式的设计方法和渲染器的设计。"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-10-25T07:20:45.000Z"><meta property="article:author" content="Jsweet"><meta property="article:tag" content="Vue"><meta property="article:tag" content="VNode"><meta property="article:tag" content="AST"><meta property="article:modified_time" content="2023-10-25T07:20:45.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"响应式设计和渲染器设计","image":[""],"dateModified":"2023-10-25T07:20:45.000Z","author":[{"@type":"Person","name":"Jsweet","url":"https://github.com/JsweetA"}]}</script><link rel="icon" href="/blogs/./favicon.ico"><title>响应式设计和渲染器设计</title><meta name="description" content="针对Vue3源码里响应式的设计方法和渲染器的设计。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/blogs/assets/style-bff87b00.css" as="style"><link rel="stylesheet" href="/blogs/assets/style-bff87b00.css">
    <link rel="modulepreload" href="/blogs/assets/app-e319b9e5.js"><link rel="modulepreload" href="/blogs/assets/响应式设计和渲染器.html-a04d59c0.js"><link rel="modulepreload" href="/blogs/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/blogs/assets/响应式设计和渲染器.html-5460969a.js"><link rel="prefetch" href="/blogs/assets/intro.html-8b519e82.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-b529c129.js" as="script"><link rel="prefetch" href="/blogs/assets/最长递增子序列.html-c8992280.js" as="script"><link rel="prefetch" href="/blogs/assets/内建组件和模块.html-cd66ca5b.js" as="script"><link rel="prefetch" href="/blogs/assets/服务端渲染.html-77adebb4.js" as="script"><link rel="prefetch" href="/blogs/assets/模板编译器.html-e7848ca8.js" as="script"><link rel="prefetch" href="/blogs/assets/组件实现原理.html-e5798467.js" as="script"><link rel="prefetch" href="/blogs/assets/00_常用配置.html-8c673630.js" as="script"><link rel="prefetch" href="/blogs/assets/404.html-d8f42e22.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-dd7793da.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-83062248.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-8adfd74d.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-a472d696.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-4c5d2e6d.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-c05d882f.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-a12353aa.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-bebec215.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-536d9b6e.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-c1f8010a.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-720f245f.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-419ca6a7.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-3782a7c9.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-0927a5a0.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-8b7975d0.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-d99a087d.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-593bbd48.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-c1bac3e3.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-c56217c9.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-c5cc70a1.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-138628ba.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-abc6a14a.js" as="script"><link rel="prefetch" href="/blogs/assets/intro.html-445200b4.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-94169644.js" as="script"><link rel="prefetch" href="/blogs/assets/最长递增子序列.html-0f348105.js" as="script"><link rel="prefetch" href="/blogs/assets/内建组件和模块.html-1e72ab3b.js" as="script"><link rel="prefetch" href="/blogs/assets/服务端渲染.html-a19a8850.js" as="script"><link rel="prefetch" href="/blogs/assets/模板编译器.html-c804a838.js" as="script"><link rel="prefetch" href="/blogs/assets/组件实现原理.html-73118b4d.js" as="script"><link rel="prefetch" href="/blogs/assets/00_常用配置.html-f95eb06f.js" as="script"><link rel="prefetch" href="/blogs/assets/404.html-0b51b84c.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-b2827d63.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-6247fb77.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-158797a2.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-e7745251.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-2edc4972.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-8503acc6.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-784bb3ae.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-7692919e.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-893000a1.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-5d81c84d.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-3e9ec937.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-bb7bbad3.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-cf5be202.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-8fe00132.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-2adca0b4.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-62ebeb2e.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-b064122f.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-b7ebb9eb.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-5b6166f5.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-6d98eb96.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-341db445.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-52ce1a17.js" as="script"><link rel="prefetch" href="/blogs/assets/giscus-0b7adcf8.js" as="script"><link rel="prefetch" href="/blogs/assets/auto-fe80bb03.js" as="script"><link rel="prefetch" href="/blogs/assets/index-2bf332f6.js" as="script"><link rel="prefetch" href="/blogs/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/blogs/assets/mermaid.core-c0b8a874.js" as="script"><link rel="prefetch" href="/blogs/assets/reveal.esm-1a4c3ae7.js" as="script"><link rel="prefetch" href="/blogs/assets/markdown.esm-9d5bc2ce.js" as="script"><link rel="prefetch" href="/blogs/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/blogs/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/blogs/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/blogs/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/blogs/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/blogs/assets/VuePlayground-14c733de.js" as="script"><link rel="prefetch" href="/blogs/assets/photoswipe.esm-1464cdb9.js" as="script"><link rel="prefetch" href="/blogs/assets/pageview-ea086c58.js" as="script"><link rel="prefetch" href="/blogs/assets/SearchResult-83270d23.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/blogs/"><img class="vp-nav-logo" src="/blogs/logo.jpg" alt><!----><!----></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="posts" class="vp-link nav-link nav-link" href="/blogs/posts/"><!---->posts<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="Algorithm" class="vp-link nav-link nav-link" href="/blogs/Algorithm/"><!---->Algorithm<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="Vue源码" class="vp-link nav-link active nav-link active" href="/blogs/Vue%E6%BA%90%E7%A0%81/"><!---->Vue源码<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="杂项" class="vp-link nav-link nav-link" href="/blogs/%E6%9D%82%E9%A1%B9/"><!---->杂项<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/JsweetA/blogs" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a aria-label="内建组件和模块" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blogs/Vue%E6%BA%90%E7%A0%81/%E5%86%85%E5%BB%BA%E7%BB%84%E4%BB%B6%E5%92%8C%E6%A8%A1%E5%9D%97.html"><!---->内建组件和模块<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="响应式设计和渲染器设计" class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active nav-link active vp-sidebar-link vp-sidebar-page active" href="/blogs/Vue%E6%BA%90%E7%A0%81/%E5%93%8D%E5%BA%94%E5%BC%8F%E8%AE%BE%E8%AE%A1%E5%92%8C%E6%B8%B2%E6%9F%93%E5%99%A8.html"><!---->响应式设计和渲染器设计<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="响应式设计" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blogs/Vue%E6%BA%90%E7%A0%81/%E5%93%8D%E5%BA%94%E5%BC%8F%E8%AE%BE%E8%AE%A1%E5%92%8C%E6%B8%B2%E6%9F%93%E5%99%A8.html#响应式设计"><!---->响应式设计<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="渲染器设计" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blogs/Vue%E6%BA%90%E7%A0%81/%E5%93%8D%E5%BA%94%E5%BC%8F%E8%AE%BE%E8%AE%A1%E5%92%8C%E6%B8%B2%E6%9F%93%E5%99%A8.html#渲染器设计"><!---->渲染器设计<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-label="服务端渲染" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blogs/Vue%E6%BA%90%E7%A0%81/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93.html"><!---->服务端渲染<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="模板编译器" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blogs/Vue%E6%BA%90%E7%A0%81/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E5%99%A8.html"><!---->模板编译器<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="组件实现原理" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blogs/Vue%E6%BA%90%E7%A0%81/%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86.html"><!---->组件实现原理<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->响应式设计和渲染器设计</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/JsweetA" target="_blank" rel="noopener noreferrer">Jsweet</a></span><span property="author" content="Jsweet"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-10-25T07:20:45.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 32 分钟</span><meta property="timeRequired" content="PT32M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category6 clickable" role="navigation">源码</span><!--]--><meta property="articleSection" content="源码"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag2 clickable" role="navigation">Vue</span><span class="page-tag-item tag2 clickable" role="navigation">VNode</span><span class="page-tag-item tag1 clickable" role="navigation">AST</span><!--]--><meta property="keywords" content="Vue,VNode,AST"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blogs/#响应式设计">响应式设计</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="/blogs/#渲染器设计">渲染器设计</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="响应式设计" tabindex="-1"><a class="header-anchor" href="#响应式设计" aria-hidden="true">#</a> 响应式设计</h2><p><a href="https://github.com/JsweetA/vue-sourceCode-study/tree/reactive/reactiveBasis" target="_blank" rel="noopener noreferrer">https://github.com/JsweetA/vue-sourceCode-study/tree/reactive/reactiveBasis<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><blockquote><p>详细请看仓库源码注释</p></blockquote><h2 id="渲染器设计" tabindex="-1"><a class="header-anchor" href="#渲染器设计" aria-hidden="true">#</a> 渲染器设计</h2><p>渲染器和响应式结合：就可以达到那种数据跟页面同步的效果</p><hr><p><a name="NfSj6"></a></p><h5 id="vue设计与实现第七章-渲染器的设计" tabindex="-1"><a class="header-anchor" href="#vue设计与实现第七章-渲染器的设计" aria-hidden="true">#</a> vue设计与实现第七章：渲染器的设计</h5><p>渲染函数：<code>renderer(vnode,container)</code></p><ul><li>vnode:虚拟节点</li><li>container：容器</li></ul><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">renderer</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h1&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
count<span class="token punctuation">.</span>value<span class="token operator">++</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>如果该节点什么都没有，属于第一次，则它叫做挂在（mount）,反之则是oldVnode和newVnode通过patch方法比较打补丁进行渲染（也就是diff）</p></blockquote><p>而渲染器则是由<code>createRenderer</code>所创建，以下是调用该函数的返回值：</p><ul><li><code>render</code>：渲染器</li><li><code>hydrate</code>：服务器的渲染器</li><li>（还有一个，忘记了）</li></ul><blockquote><p>其实不管是第一次渲染还是第二次渲染，其实都可以叫做打补丁，一般来讲第一次叫做挂载，其他叫做打补丁，毕竟渲染器的主要工作就是挂载、更新和渲染。</p></blockquote><p><em>render：</em></p><ol><li><em>if vnode is exist</em><ol><li><em>patch(oldVnode,vnode,container)</em></li></ol></li><li>_else _ <ol><li><em>if oldVnode is exist</em></li><li><em>oldVnode = null</em></li></ol></li><li><em>oldVnode = vnode</em></li></ol><blockquote><p>其中第二步是指新的不存在，而旧的存在的话，应该执行unmount操作。</p></blockquote><p>vnode是一个object，其中有<code>type</code>，<code>children</code>，<code>props</code>等属性，而<code>render</code>可以将这种<code>vnode</code>转换成真实dom，简单的这种操作就可以通过封装一个方法去调用api进行创建和挂载。<br>不过考虑到耦合性，为了使这种模板可以在不同环境下运行，所以这种调用api的东西，挂在的东西都是外部传进这个<code>createRenderer</code>函数里的。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>vnode <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">&#39;h1&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span><span class="token string">&#39;我是一个vnodeObj&#39;</span>
  <span class="token comment">// children:[</span>
  <span class="token comment">//   {...},</span>
  <span class="token comment">//]</span>
  <span class="token comment">// 对象数组，里面存放的是vnode</span>
<span class="token punctuation">}</span>
<span class="token comment">// 转换后应该是&lt;h1&gt;我是一个vnodeObj&lt;/h1&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>总之，渲染器的作用就是将vnode渲染成真实dom，通过不断地patch</p><hr><p><a name="dxqXL"></a></p><h5 id="vue设计与实现第八章-挂载与更新" tabindex="-1"><a class="header-anchor" href="#vue设计与实现第八章-挂载与更新" aria-hidden="true">#</a> vue设计与实现第八章：挂载与更新</h5><p><a name="INv7B"></a></p><h6 id="_8-1-8-3-挂在子节点和元素属性和正确的设置元素属性" tabindex="-1"><a class="header-anchor" href="#_8-1-8-3-挂在子节点和元素属性和正确的设置元素属性" aria-hidden="true">#</a> 8.1-8.3：挂在子节点和元素属性和正确的设置元素属性</h6><p><code>mountElement</code>函数</p><ul><li>vnode</li><li>container</li></ul><p>它会去判断<code>vnode.children</code>属性是否是<code>string</code>,是的话就直接挂在文本内容，反之如果是数组，则进行将数组内的内容全部挂在到<code>vnode.type</code>上，然后最后插入到<code>container</code>。<br>添加<code>el</code>的属性有两种方式：</p><ul><li><code>HTML Attributes</code></li><li><code>DOM Properties</code></li></ul><p>问题：<code>attributes</code>与<code>DOM Properties</code>不是直接映射,存在一个<code>HTML Attributes</code> 会关联多个<code>DOM Properties</code>的情况。</p><blockquote><p>来自书里所讲：“只需要记住一个原则：<code>HTML Attributes</code> 是 设置与之对应的<code>DOM Properties</code>的初始值”</p></blockquote><p>所以要正确的设置元素属性，需要看情况来进行判断赋值</p><blockquote><p>浏览器会自动解析HTMl代码，自动分析并且设置<code>DOM Properties</code>，但是Vue所采用的是vnode，所以需要自己去把这个活接过来。</p></blockquote><p><a name="BbbQ0"></a></p><h6 id="_8-4-class的处理" tabindex="-1"><a class="header-anchor" href="#_8-4-class的处理" aria-hidden="true">#</a> 8.4：class的处理</h6><p><code>props</code>下的<code>class</code>属性有以下三种定义：</p><ul><li><code>class=&quot;bar foo&quot;</code></li><li><code>:class=&#39;{foo:true,bar:true}&#39;</code></li><li><code>:class=&#39;[&#39;bar&#39;,{foo:true}]&#39;</code></li></ul><p>处理该属性有一个<code>normalizeClass</code>函数，用来整合这些定义，全部转换为字符串的格式<br>设置该属性有<code>el.className</code>,<code>setAttribute</code>,<code>el.classList</code>三种方法，但是考虑到性能问题，所以用的是<code>el.className</code>。于是就是接着在<code>patchProps</code>函数上打补丁</p><blockquote><p>同理，<code>style</code>属性也需要这种整合函数进行字符串化进行设置</p></blockquote><p><a name="OfDLN"></a></p><h6 id="_8-5-卸载操作" tabindex="-1"><a class="header-anchor" href="#_8-5-卸载操作" aria-hidden="true">#</a> 8.5：卸载操作</h6><p>首次渲染后，后期渲染的<code>vnode</code>如果传的是<code>null</code>说明要执行卸载操作,但是考虑到以下几点问题</p><ul><li>容器可能是由多个组件渲染，卸载时应该调用这些组件的<code>unmounted</code>，<code>beforeUnmounted</code>生命周期函数</li><li>有些元素存在自定义指令，卸载时应该要正确执行对应的指令钩子</li><li>如果直接使用<code>innerHtml</code>去清空的话，他不会移除那些绑定在<code>DOM</code>元素上的钩子</li></ul><p>所以考虑到以上三点，卸载操作，应该是通过<code>vnode</code>获取到真实<code>DOM</code>,然后通过<code>DOM</code>的原生方法进行移除。在<code>vnode</code>对象上创建一个<code>el</code>属性，用来记录真实<code>DOM</code>。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>     <span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>_vnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">04</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">05</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">06</span>       <span class="token comment">// 根据 vnode 获取要卸载的真实 DOM 元素</span>
<span class="token number">07</span>       <span class="token keyword">const</span> el <span class="token operator">=</span> container<span class="token punctuation">.</span>_vnode<span class="token punctuation">.</span>el
<span class="token number">08</span>       <span class="token comment">// 获取 el 的父元素</span>
<span class="token number">09</span>       <span class="token keyword">const</span> parent <span class="token operator">=</span> el<span class="token punctuation">.</span>parentNode
<span class="token number">10</span>       <span class="token comment">// 调用 removeChild 移除元素</span>
<span class="token number">11</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
<span class="token number">12</span>     <span class="token punctuation">}</span>
<span class="token number">13</span>   <span class="token punctuation">}</span>
<span class="token number">14</span>   container<span class="token punctuation">.</span>_vnode <span class="token operator">=</span> vnode
<span class="token number">15</span> <span class="token punctuation">}</span>
<span class="token number">16</span> <span class="token comment">// container._vnode是oldVnode</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后考虑到该操作会很频繁页很常见，所以封装成<code>unmount</code>函数。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">const</span> parent <span class="token operator">=</span> vnode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>parentNode
<span class="token number">03</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">04</span>     parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
<span class="token number">05</span>   <span class="token punctuation">}</span>
<span class="token number">06</span> <span class="token punctuation">}</span>
<span class="token number">07</span> <span class="token comment">// 上面就只需要进行调用unmount(container._vnode) </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>此时还有一个好处就是，他独立出去了，unmount和beforeunmounted生命周期就出现了，还可以进行检测该东东是否是组件了，是组件就可以调用前面所说的生命周期函数</p></blockquote><p><a name="MXrmX"></a></p><h6 id="_8-6-区分vnode的类型" tabindex="-1"><a class="header-anchor" href="#_8-6-区分vnode的类型" aria-hidden="true">#</a> 8.6：区分vnode的类型</h6><p>先梳理一下执行流程</p><ol><li>通过<code>createRenderer</code>函数创建一个<code>renderer</code></li><li>通过调用<code>renderer.render</code>方法将<code>vnode</code>挂载到<code>container</code>上</li><li>此时的<code>render</code>函数会进行判断 <ol><li><em>if vnode is null</em> ：<code>unmount(container._vnode)</code></li><li><em>else vnode not is null</em> : <code>patch(oldVnode,newVnode,container)</code></li></ol></li><li>走到这里一定是进行<code>patch</code>了的，又会进行判断 <ol><li><em>if oldVnode is null :</em><code>mountElement(newVnode,contaienr)</code></li><li><em>else oldVnode not is ：</em><code>patchElement(oldVnode,newVnode)</code></li></ol></li></ol><p><code>patch</code>函数的作用是将新旧<code>vnode</code>进行对比，然后把不同的地方进行替换，再渲染成真实<code>DOM</code>，不过考虑到所传进来的<code>vnode</code>并不是同一种类型，此时所作的操作应该时先卸载<code>oldVnode</code>,再挂载<code>newVnode</code>。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token comment">// 如果 n1 存在，则对比 n1 和 n2 的类型</span>
<span class="token number">03</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>type <span class="token operator">!==</span> n2<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">04</span>     <span class="token comment">// 如果新旧 vnode 的类型不同，则直接将旧 vnode 卸载</span>
<span class="token number">05</span>     <span class="token function">unmount</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>
<span class="token number">06</span>     n1 <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token number">07</span>   <span class="token punctuation">}</span>
<span class="token number">08</span>
<span class="token number">09</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">10</span>     <span class="token function">mountElement</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">11</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">12</span>     <span class="token comment">// 更新</span>
<span class="token number">13</span>   <span class="token punctuation">}</span>
<span class="token number">14</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而且除了类型上，其实不同的标签应该有不同的处理方式，所以还需要进一步的判断。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>type <span class="token operator">!==</span> n2<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>     <span class="token function">unmount</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>
<span class="token number">04</span>     n1 <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token number">05</span>   <span class="token punctuation">}</span>
<span class="token number">06</span>   <span class="token comment">// 代码运行到这里，证明 n1 和 n2 所描述的内容相同</span>
<span class="token number">07</span>   <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> n2
<span class="token number">08</span>   <span class="token comment">// 如果 n2.type 的值是字符串类型，则它描述的是普通标签元素</span>
<span class="token number">09</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">10</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">11</span>       <span class="token function">mountElement</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">12</span>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">13</span>       <span class="token function">patchElement</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span>
<span class="token number">14</span>     <span class="token punctuation">}</span>
<span class="token number">15</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">16</span>     <span class="token comment">// 如果 n2.type 的值的类型是对象，则它描述的是组件</span>
<span class="token number">17</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">&#39;xxx&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">18</span>     <span class="token comment">// 处理其他类型的 vnode</span>
<span class="token number">19</span>   <span class="token punctuation">}</span>
<span class="token number">20</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a name="T3Vs4"></a></p><h6 id="_8-7-事件的处理" tabindex="-1"><a class="header-anchor" href="#_8-7-事件的处理" aria-hidden="true">#</a> 8.7：事件的处理</h6><p><code>patchProps</code>函数：用来对元素属性打补丁的函数。<br>是通过<code>createRenderer</code>内所传的<code>options</code>带来的。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token function">patchProps</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> prevValue<span class="token punctuation">,</span> nextValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token comment">// 匹配以 on 开头的属性，视其为事件</span>
<span class="token number">03</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">04</span>     <span class="token comment">// 根据属性名称得到对应的事件名称，例如 onClick ---&gt; click</span>
<span class="token number">05</span>     <span class="token keyword">const</span> name <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">06</span>     <span class="token comment">// 绑定事件，nextValue 为事件处理函数</span>
<span class="token number">07</span>     el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> nextValue<span class="token punctuation">)</span>
<span class="token number">08</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;class&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">09</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">10</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSetAsProps</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> nextValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">11</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">12</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">13</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">14</span>   <span class="token punctuation">}</span>
<span class="token number">15</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>事件这个也算<code>vnode.props</code>里，为了更明确的知道属性里哪个是事件，就统一安排<code>on</code>为前缀，这样就方便处理了。<br>通过调用<code>addEventListener</code>绑定事件，更新跟更新<code>vnode</code>一样，先卸载，在挂载。</p><blockquote><p>性能优化：创建应该invoker,并且将函数缓存在invoker.value里面，然后调用的时候就调用这个，更新的时候覆盖invoker.value的值即可，就避免了一次remove的操作</p></blockquote><p>优化过性能后存在一个问题：缓存只缓存了一个，出现多个事件会进行覆盖。<br>解决：将<code>el._vei</code>设置为一个对象 <code>key-&gt;func</code>。</p><blockquote><p>这里有一个新知识，之前看过一个问题，js中的object底层是什么，其实我第一想法是key-value的数据结构，然后我去问chatgpt，他说HashMap（确实嗷）<br> 后面还有需求是一个事件可以绑定多个函数，emmm这种补丁加个判断就好了</p></blockquote><p><a name="Hg9B4"></a></p><h6 id="_8-8-事件冒泡与更新时机问题" tabindex="-1"><a class="header-anchor" href="#_8-8-事件冒泡与更新时机问题" aria-hidden="true">#</a> 8.8：事件冒泡与更新时机问题</h6><p>问题代码示例：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> effect<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token operator">=</span> VueReactivity
<span class="token number">02</span>
<span class="token number">03</span> <span class="token keyword">const</span> bol <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token number">04</span>
<span class="token number">05</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token number">06</span>   <span class="token comment">// 创建 vnode</span>
<span class="token number">07</span>   <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token number">08</span>     <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
<span class="token number">09</span>     <span class="token literal-property property">props</span><span class="token operator">:</span> bol<span class="token punctuation">.</span>value <span class="token operator">?</span> <span class="token punctuation">{</span>
<span class="token number">10</span>       <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token number">11</span>         <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&#39;父元素 clicked&#39;</span><span class="token punctuation">)</span>
<span class="token number">12</span>       <span class="token punctuation">}</span>
<span class="token number">13</span>     <span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">14</span>     <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token number">15</span>       <span class="token punctuation">{</span>
<span class="token number">16</span>         <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;p&#39;</span><span class="token punctuation">,</span>
<span class="token number">17</span>         <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token number">18</span>           <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token number">19</span>             bol<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token number">20</span>           <span class="token punctuation">}</span>
<span class="token number">21</span>         <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">22</span>         <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">&#39;text&#39;</span>
<span class="token number">23</span>       <span class="token punctuation">}</span>
<span class="token number">24</span>     <span class="token punctuation">]</span>
<span class="token number">25</span>   <span class="token punctuation">}</span>
<span class="token number">26</span>   <span class="token comment">// 渲染 vnode</span>
<span class="token number">27</span>   renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">28</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此时点击<code>p</code>会触发他的点击事件，由于绑定了一个<code>ref</code>变量，父元素<code>div</code>的分支应该是处于<code>{}</code>,就算事件冒泡，也不需要进行触发点击事件。但是结果却是触发了，看下图：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1679638067368-def3acdd-bdcb-4a94-9e46-6a40bdef7fd5.png#averageHue=%23d8d8d8&amp;clientId=u8ad3f223-1d49-4&amp;from=paste&amp;height=446&amp;id=u74f5d236&amp;originHeight=1020&amp;originWidth=1034&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=192021&amp;status=done&amp;style=none&amp;taskId=u6b87793b-1ccf-46dc-9aab-6204ea877ff&amp;title=&amp;width=452" alt="image.png" loading="lazy"><br>在点击后，他修改了<code>ref</code>变量，于是执行了副作用函数，进行重新渲染，提前改变了使得<code>div</code>的点击事件进行了分支切换，并且绑定到了<code>div</code>上，所以会触发<code>div</code>的点击事件。<br>解决方案：判断绑定事件的时间是否小于触发事件即可。</p><blockquote><p>我看到这的时候第一想法是，将渲染往后推，冒泡往前走，但是考虑到冒泡的事件何时开始与何时结束都是不可预料的，所以行不通</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token function">patchProps</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> prevValue<span class="token punctuation">,</span> nextValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>     <span class="token keyword">const</span> invokers <span class="token operator">=</span> el<span class="token punctuation">.</span>_vei <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_vei <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token number">04</span>     <span class="token keyword">let</span> invoker <span class="token operator">=</span> invokers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token number">05</span>     <span class="token keyword">const</span> name <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">06</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">07</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>invoker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">08</span>         invoker <span class="token operator">=</span> el<span class="token punctuation">.</span>_vei<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token number">09</span>           <span class="token comment">// e.timeStamp 是事件发生的时间</span>
<span class="token number">10</span>           <span class="token comment">// 如果事件发生的时间早于事件处理函数绑定的时间，则不执行事件处理函数</span>
<span class="token number">11</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>timeStamp <span class="token operator">&lt;</span> invoker<span class="token punctuation">.</span>attached<span class="token punctuation">)</span> <span class="token keyword">return</span>
<span class="token number">12</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">13</span>             invoker<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">14</span>           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">15</span>             invoker<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token number">16</span>           <span class="token punctuation">}</span>
<span class="token number">17</span>         <span class="token punctuation">}</span>
<span class="token number">18</span>         invoker<span class="token punctuation">.</span>value <span class="token operator">=</span> nextValue
<span class="token number">19</span>         <span class="token comment">// 添加 invoker.attached 属性，存储事件处理函数被绑定的时间</span>
<span class="token number">20</span>         invoker<span class="token punctuation">.</span>attached <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">21</span>         el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> invoker<span class="token punctuation">)</span>
<span class="token number">22</span>       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">23</span>         invoker<span class="token punctuation">.</span>value <span class="token operator">=</span> nextValue
<span class="token number">24</span>       <span class="token punctuation">}</span>
<span class="token number">25</span>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>invoker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">26</span>       el<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> invoker<span class="token punctuation">)</span>
<span class="token number">27</span>     <span class="token punctuation">}</span>
<span class="token number">28</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;class&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">29</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">30</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSetAsProps</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> nextValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">31</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">32</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">33</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">34</span>   <span class="token punctuation">}</span>
<span class="token number">35</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>来自书中的补充：<br> “在关于时间的存储和比较方面，我们使用的是高精时间，即 performance.now。但根据浏览器的不同，e.timeStamp 的值也会有所不同。它既可能是高精时间，也可能是非高精时间。因此，严格来讲，这里需要做兼容处理。不过在 Chrome 49、Firefox 54、Opera 36 以及之后的版本中，e.timeStamp 的值都是高精时间。”</p></blockquote><p><a name="u1Lij"></a></p><h6 id="_8-9-更新子节点" tabindex="-1"><a class="header-anchor" href="#_8-9-更新子节点" aria-hidden="true">#</a> 8.9：更新子节点</h6><p>子元素的状态：</p><ul><li>没有子节点，此时 vnode.children 的值为 null。</li><li>具有文本子节点，此时 vnode.children 的值为字符串，代表文本的内容。</li><li>其他情况，无论是单个元素子节点，还是多个子节点（可能是文本和元素的混合），都可以用数组来表示。</li></ul><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token comment">// 没有子节点</span>
<span class="token number">02</span> vnode <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token number">03</span>   <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
<span class="token number">04</span>   <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token number">05</span> <span class="token punctuation">}</span>
<span class="token number">06</span> <span class="token comment">// 文本子节点</span>
<span class="token number">07</span> vnode <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token number">08</span>   <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
<span class="token number">09</span>   <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">&#39;Some Text&#39;</span>
<span class="token number">10</span> <span class="token punctuation">}</span>
<span class="token number">11</span> <span class="token comment">// 其他情况，子节点使用数组表示</span>
<span class="token number">12</span> vnode <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token number">13</span>   <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span>
<span class="token number">14</span>   <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token number">15</span>     <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;p&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">16</span>     <span class="token string">&#39;Some Text&#39;</span>
<span class="token number">17</span>   <span class="token punctuation">]</span>
<span class="token number">18</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>patchElement</code>函数主要执行两个功能</p><ul><li><code>patchProps</code></li><li><code>patchChildren</code></li></ul><p>这章主要讲的是<code>patchChildren</code>函数。</p><blockquote><p>对于更新children，我的想法是，卸载原有的，安装新的。不过为了使这个方法更加强大，所以需要做一些判断</p></blockquote><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">patchChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> n2<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">04</span>       n1<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unmount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">05</span>     <span class="token punctuation">}</span>
<span class="token number">06</span>     <span class="token function">setElementText</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
<span class="token number">07</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">08</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">09</span>       <span class="token comment">// diff</span>
<span class="token number">10</span>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">11</span>       <span class="token function">setElementText</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
<span class="token number">12</span>       n2<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">13</span>     <span class="token punctuation">}</span>
<span class="token number">14</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">15</span>     <span class="token comment">// 代码运行到这里，说明新子节点不存在</span>
<span class="token number">16</span>     <span class="token comment">// 旧子节点是一组子节点，只需逐个卸载即可</span>
<span class="token number">17</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">18</span>       n1<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token function">unmount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">19</span>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> n1<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">20</span>       <span class="token comment">// 旧子节点是文本子节点，清空内容即可</span>
<span class="token number">21</span>       <span class="token function">setElementText</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
<span class="token number">22</span>     <span class="token punctuation">}</span>
<span class="token number">23</span>     <span class="token comment">// 如果也没有旧子节点，那么什么都不需要做</span>
<span class="token number">24</span>   <span class="token punctuation">}</span>
<span class="token number">25</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码如上，分析如下：</p><ol><li><em>判断</em><code>_newVnode_</code><em>是否是</em><code>_string_</code><ol><li><em>如果是，则判断</em><code>_oldVnode_</code><em>是否是数组</em><ol><li><em>如果是就逐个卸载，并且挂在文本</em></li></ol></li><li><em>不是数组就不需要管，直接挂载文本</em></li></ol></li><li><em>当不是</em><code>_string_</code><em>的时候，判断</em><code>_newVnode_</code><em>是否是数组</em><ol><li><em>如果是，则判断</em><code>_oldVnode_</code><em>是否是数组</em><ol><li><code>_Diff_</code><em>算法</em></li></ol></li><li><em>卸载文本，再挂载数组</em></li></ol></li><li><em>既不是</em><code>_string_</code><em>,也不是数组，这里的</em><code>_newVnode_</code><em>就一定时空了</em><ol><li><em>重复如第一步的操作一样，只需要把后面挂载文本改成挂在</em><code>_&#39;&#39;_</code><br><a name="OqUF5"></a></li></ol></li></ol><h6 id="_8-10-文本注释和注释节点" tabindex="-1"><a class="header-anchor" href="#_8-10-文本注释和注释节点" aria-hidden="true">#</a> 8.10：文本注释和注释节点</h6><p>...<br><a name="VeleT"></a></p><h6 id="_8-11-fragment" tabindex="-1"><a class="header-anchor" href="#_8-11-fragment" aria-hidden="true">#</a> 8.11：Fragment</h6><p>名为片段，作用是解决了vue2不支持多根节点模板的问题。</p><p><a name="dwKG1"></a></p><h6 id="_8-12-总结" tabindex="-1"><a class="header-anchor" href="#_8-12-总结" aria-hidden="true">#</a> 8.12：总结</h6><p>章节总结自己翻书。</p><hr><p>1.<code>render</code>函数：</p><ol><li>首先调用<code>render</code>函数，传递<code>vnode</code>，<code>container</code>两个参数 <ol><li>进入<code>render</code>函数后会进行判断<code>vnode</code>是否是<code>null</code><ol><li>是<code>null</code>则进行<code>unmount</code>的操作</li><li>反之则进行<code>patch</code>操作，进行对<code>oldVnode</code>和<code>newVnode</code>比较</li></ol></li></ol></li></ol><hr><p>2.<code>patch</code>函数：</p><ol><li>进入<code>patch</code>函数后判断新旧<code>vnode</code>的类型是否一样，不是一样就先卸载<code>oldVnode</code></li><li>取出<code>newVnode</code>的类型，这里有<code>Text</code>，<code>Comment</code>，<code>Fragment</code>，<code>Static</code>，<code>default</code><ol><li>如果是前四种类型的节点，则会调用对应的<code>process</code>方法进行挂载到<code>container</code>上</li><li>这个分支是<code>default</code>的执行，会判断节点是组件还是节点，如果是节点则调用<code>processElement</code>方法，反之则调用<code>processComponent</code>方法</li></ol></li></ol><hr><p>3.<code>processElement</code>函数：</p><ol><li>判断<code>oldVnode</code>是否是空，是空的话则调用<code>mountElement</code>方法</li><li>反之调用<code>patchElement</code>方法</li></ol><hr><p>4.<code>mountElement</code>函数：</p><ol><li>因为是第一次挂载，进行创建<code>DOM el</code></li><li>然后判断<code>children</code>类型是<code>string</code>还是<code>array</code><ol><li>是<code>string</code>则进行挂载文本</li><li>反之进行循环遍历数组进行<code>patch</code>子节点</li></ol></li><li>调用<code>patchProps</code>函数添加属性</li></ol><hr><p>5.<code>patchProps</code>函数：</p><ol><li>对于<code>class</code>，<code>style</code>，<code>event</code>都是特殊属性，需要做特殊处理，调用对应的<code>patch-</code>函数</li><li>除了以上三个，就是属性了，根据属性自身特性进行对应挂载。</li><li>还有<code>vue</code>的指令挂载</li></ol><hr><p>5.<code>patchElement</code>函数：</p><ol><li>更新<code>props</code>通过调用<code>patchProps</code>方法</li><li>更新<code>children</code>通过调用<code>patchChildren</code></li></ol><blockquote><p>源码里面其实还做了其他的操作，而且patch，应该接着patch指令，我这些总结是一部分书上一部分源码上的，函数名都能从源码里找到的</p></blockquote><hr><p>6.<code>patchChildren</code>函数：</p><ol><li>判断<code>newVnode.children</code>是不是<code>string</code><ol><li>判断<code>oldVnode.children</code>是不是<code>array</code>是的话就循环卸载<code>oldVnode.children</code></li></ol></li><li>判断<code>newVnode.children</code>是不是<code>array</code><ol><li>判断<code>oldVnode.children</code>是不是<code>array</code>,如果是就进行<code>diff</code>算法，反之则循环挂载<code>newVnode.children</code></li></ol></li><li>既不是<code>string</code>也不是<code>array</code>,那只能是<code>null</code><ol><li>卸载<code>oldVnode</code><br><a name="SyGDk"></a></li></ol></li></ol><h5 id="vue设计与实现第九章-简单diff算法" tabindex="-1"><a class="header-anchor" href="#vue设计与实现第九章-简单diff算法" aria-hidden="true">#</a> vue设计与实现第九章：简单Diff算法</h5><p><a name="x9aMU"></a></p><h6 id="_9-1-减少dom操作的性能开销" tabindex="-1"><a class="header-anchor" href="#_9-1-减少dom操作的性能开销" aria-hidden="true">#</a> 9.1：减少DOM操作的性能开销</h6><p>旧的<code>patchChildren</code>在处理新旧<code>vnode</code>都是<code>array</code>时，是先全部卸载<code>oldVnode</code>,再挂载<code>newVnode</code>，算法的成本很大。有时候有一些节点，单纯可能只是文本值改变了，并不需要卸载和挂载操作，只需要更新文本值即可。于是<code>diff</code>算法就是来解决这个问题的。<br>方案一：逐个比较新旧<code>vnode.children</code>，解决了<code>DOM</code>的开销，但问题却是，如果新旧<code>vnode</code>的个数不一样，所以需要考虑新旧<code>vnode.children</code>的长度，旧的多了应该卸载，新的多了应该挂载，不能只是单纯的更新。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">patchChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> n2<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">04</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">05</span>     <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> n1<span class="token punctuation">.</span>children
<span class="token number">06</span>     <span class="token keyword">const</span> newChildren <span class="token operator">=</span> n2<span class="token punctuation">.</span>children
<span class="token number">07</span>     <span class="token comment">// 旧的一组子节点的长度</span>
<span class="token number">08</span>     <span class="token keyword">const</span> oldLen <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length
<span class="token number">09</span>     <span class="token comment">// 新的一组子节点的长度</span>
<span class="token number">10</span>     <span class="token keyword">const</span> newLen <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length
<span class="token number">11</span>     <span class="token comment">// 两组子节点的公共长度，即两者中较短的那一组子节点的长度</span>
<span class="token number">12</span>     <span class="token keyword">const</span> commonLength <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>oldLen<span class="token punctuation">,</span> newLen<span class="token punctuation">)</span>
<span class="token number">13</span>     <span class="token comment">// 遍历 commonLength 次</span>
<span class="token number">14</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> commonLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">15</span>       <span class="token function">patch</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">16</span>     <span class="token punctuation">}</span>
<span class="token number">17</span>     <span class="token comment">// 如果 newLen &gt; oldLen，说明有新子节点需要挂载</span>
<span class="token number">18</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>newLen <span class="token operator">&gt;</span> oldLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">19</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> commonLength<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">20</span>         <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">21</span>       <span class="token punctuation">}</span>
<span class="token number">22</span>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldLen <span class="token operator">&gt;</span> newLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">23</span>       <span class="token comment">// 如果 oldLen &gt; newLen，说明有旧子节点需要卸载</span>
<span class="token number">24</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> commonLength<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">25</span>         <span class="token function">unmount</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token number">26</span>       <span class="token punctuation">}</span>
<span class="token number">27</span>     <span class="token punctuation">}</span>
<span class="token number">28</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">29</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">30</span>   <span class="token punctuation">}</span>
<span class="token number">31</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a name="ilIY2"></a></p><h6 id="_9-2-dom复用和key的作用" tabindex="-1"><a class="header-anchor" href="#_9-2-dom复用和key的作用" aria-hidden="true">#</a> 9.2：DOM复用和key的作用</h6><p>有些时候，新旧<code>vnode.children</code>的内容有很多相同，不需要做改动的操作，这个时候，这些相同的<code>DOM</code>是可以保留下面，不需要更新也不需要挂载和卸载，所以下一个优化方向是，如何知道这个<code>DOM</code>既出现在<code>oldVnode.children</code>，也出现在<code>newVnode.children</code>。<br>引入<code>key</code>,唯一标识符。这样就可以知道在不在了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1679812023829-38ae91c1-3fc6-445c-95d1-9dbaba92d073.png#averageHue=%23ebebeb&amp;clientId=uc9d64d88-5777-4&amp;from=paste&amp;height=244&amp;id=u5adc75c1&amp;originHeight=244&amp;originWidth=635&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=38084&amp;status=done&amp;style=none&amp;taskId=u1afe2894-cf34-4bf5-87ea-940b34303dd&amp;title=&amp;width=635" alt="image.png" loading="lazy"><br>但是，<code>key</code>相同，并不一定意味着可以直接复用，他们的<code>children</code>可能会不一样。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">patchChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> n2<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">04</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">05</span>     <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> n1<span class="token punctuation">.</span>children
<span class="token number">06</span>     <span class="token keyword">const</span> newChildren <span class="token operator">=</span> n2<span class="token punctuation">.</span>children
<span class="token number">07</span>
<span class="token number">08</span>     <span class="token comment">// 遍历新的 children</span>
<span class="token number">09</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">10</span>       <span class="token keyword">const</span> newVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token number">11</span>       <span class="token comment">// 遍历旧的 children</span>
<span class="token number">12</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">13</span>         <span class="token keyword">const</span> oldVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token number">14</span>         <span class="token comment">// 如果找到了具有相同 key 值的两个节点，说明可以复用，但仍然需要调用 patch 函数更新</span>
<span class="token number">15</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>newVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">16</span>           <span class="token function">patch</span><span class="token punctuation">(</span>oldVNode<span class="token punctuation">,</span> newVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">17</span>           <span class="token keyword">break</span> <span class="token comment">// 这里需要 break</span>
<span class="token number">18</span>         <span class="token punctuation">}</span>
<span class="token number">19</span>       <span class="token punctuation">}</span>
<span class="token number">20</span>     <span class="token punctuation">}</span>
<span class="token number">21</span>
<span class="token number">22</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">23</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">24</span>   <span class="token punctuation">}</span>
<span class="token number">25</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a name="NOGZI"></a></p><h6 id="_9-3-找到需要移动的元素" tabindex="-1"><a class="header-anchor" href="#_9-3-找到需要移动的元素" aria-hidden="true">#</a> 9.3：找到需要移动的元素</h6><p>上面解决了找到可复用的节点。这里就是用来考虑该节点是否需要移动。<br>如何判断该元素需要移动：如果索引值具有单调递增的特性，说明不需要移动，但是中途有索引比当前状态下的最大索引要小，说明该节点需要移动。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">patchChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> n2<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">04</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">05</span>     <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> n1<span class="token punctuation">.</span>children
<span class="token number">06</span>     <span class="token keyword">const</span> newChildren <span class="token operator">=</span> n2<span class="token punctuation">.</span>children
<span class="token number">07</span>
<span class="token number">08</span>     <span class="token comment">// 用来存储寻找过程中遇到的最大索引值</span>
<span class="token number">09</span>     <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span>
<span class="token number">10</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">11</span>       <span class="token keyword">const</span> newVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token number">12</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">13</span>         <span class="token keyword">const</span> oldVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token number">14</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>newVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">15</span>           <span class="token function">patch</span><span class="token punctuation">(</span>oldVNode<span class="token punctuation">,</span> newVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">16</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">17</span>             <span class="token comment">// 如果当前找到的节点在旧 children 中的索引小于最大索引值 lastIndex，</span>
<span class="token number">18</span>             <span class="token comment">// 说明该节点对应的真实 DOM 需要移动</span>
<span class="token number">19</span>           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">20</span>             <span class="token comment">// 如果当前找到的节点在旧 children 中的索引不小于最大索引值，</span>
<span class="token number">21</span>             <span class="token comment">// 则更新 lastIndex 的值</span>
<span class="token number">22</span>             lastIndex <span class="token operator">=</span> j
<span class="token number">23</span>           <span class="token punctuation">}</span>
<span class="token number">24</span>           <span class="token keyword">break</span> <span class="token comment">// 这里需要 break</span>
<span class="token number">25</span>         <span class="token punctuation">}</span>
<span class="token number">26</span>       <span class="token punctuation">}</span>
<span class="token number">27</span>     <span class="token punctuation">}</span>
<span class="token number">28</span>
<span class="token number">29</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">30</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">31</span>   <span class="token punctuation">}</span>
<span class="token number">32</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a name="xG18S"></a></p><h6 id="_9-4-如何移动" tabindex="-1"><a class="header-anchor" href="#_9-4-如何移动" aria-hidden="true">#</a> 9.4：如何移动</h6><p>这里的移动是值移动真实<code>DOM</code>，而不是移动虚拟<code>DOM</code>。</p><blockquote><p>如果移动的是vnode，那又需要挂载，等于白干</p></blockquote><p><code>vnode.el</code>记录的是真实<code>DOM</code>,所以可以利用它来进行<code>DOM</code>的移动。<br>根据上面的算法来模拟一遍，起始的索引是0，遍历新子节点数组，如何在旧子节点数组里第一个元素<code>p-3</code>可得，索引为2，此时2比起始索引大（最大索引记为<code>lastIndex</code>），所以<code>p-3</code>不需要移动，并且更新<code>lastIndex</code>为2。<br>接着找<code>p-1</code>的索引，值为0，比<code>lastIndex</code>要小，说明需要移动，移动到何处，由新子节点的顺序规定，也就是移动到<code>newVnode[i - 1]</code>的后面。<br>然后就是<code>p-2</code>，跟找<code>p-1</code>同理。<br>看代码：</p><ul><li><code>anchor</code>：锚点，用于移动到哪，配合<code>insertBefore</code>使用。</li><li><code>el.nextSibling</code>：获取兄弟节点的下一个节点，然后赋值给<code>anchor</code>。</li><li><code>insertBefore</code>：两个参数，第一个参数为需要插入的节点，第二个参数是位置。</li></ul><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">patchChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> n2<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">04</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">05</span>     <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> n1<span class="token punctuation">.</span>children
<span class="token number">06</span>     <span class="token keyword">const</span> newChildren <span class="token operator">=</span> n2<span class="token punctuation">.</span>children
<span class="token number">07</span>
<span class="token number">08</span>     <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span>
<span class="token number">09</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">10</span>       <span class="token keyword">const</span> newVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token number">11</span>       <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span>
<span class="token number">12</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">13</span>         <span class="token keyword">const</span> oldVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token number">14</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>newVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">15</span>           <span class="token function">patch</span><span class="token punctuation">(</span>oldVNode<span class="token punctuation">,</span> newVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">16</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">17</span>             <span class="token comment">// 代码运行到这里，说明 newVNode 对应的真实 DOM 需要移动</span>
<span class="token number">18</span>             <span class="token comment">// 先获取 newVNode 的前一个 vnode，即 prevVNode</span>
<span class="token number">19</span>             <span class="token keyword">const</span> prevVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token number">20</span>             <span class="token comment">// 如果 prevVNode 不存在，则说明当前 newVNode 是第一个节点，它不需要移动</span>
<span class="token number">21</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>prevVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">22</span>               <span class="token comment">// 由于我们要将 newVNode 对应的真实 DOM 移动到 prevVNode 所对应真实 DOM 后面，</span>
<span class="token number">23</span>               <span class="token comment">// 所以我们需要获取 prevVNode 所对应真实 DOM 的下一个兄弟节点，并将其作为锚点</span>
<span class="token number">24</span>               <span class="token keyword">const</span> anchor <span class="token operator">=</span> prevVNode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling
<span class="token number">25</span>               <span class="token comment">// 调用 insert 方法将 newVNode 对应的真实 DOM 插入到锚点元素前面，</span>
<span class="token number">26</span>               <span class="token comment">// 也就是 prevVNode 对应真实 DOM 的后面</span>
<span class="token number">27</span>               <span class="token function">insert</span><span class="token punctuation">(</span>newVNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
<span class="token number">28</span>             <span class="token punctuation">}</span>
<span class="token number">29</span>           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">30</span>             lastIndex <span class="token operator">=</span> j
<span class="token number">31</span>           <span class="token punctuation">}</span>
<span class="token number">32</span>           <span class="token keyword">break</span>
<span class="token number">33</span>         <span class="token punctuation">}</span>
<span class="token number">34</span>       <span class="token punctuation">}</span>
<span class="token number">35</span>     <span class="token punctuation">}</span>
<span class="token number">36</span>
<span class="token number">37</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">38</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">39</span>   <span class="token punctuation">}</span>
<span class="token number">40</span> <span class="token punctuation">}</span>


<span class="token number">01</span> <span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token comment">// 省略部分代码</span>
<span class="token number">03</span>
<span class="token number">04</span>   <span class="token function">insert</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> anchor <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">05</span>     <span class="token comment">// insertBefore 需要锚点元素 anchor</span>
<span class="token number">06</span>     parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span> <span class="token comment">// 如果anchor为null，则会插入到最后面</span>
<span class="token number">07</span>   <span class="token punctuation">}</span>
<span class="token number">08</span>
<span class="token number">09</span>   <span class="token comment">// 省略部分代码</span>
<span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看图：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1679814510817-acbe6781-1da2-43b6-9a36-29b086cd2b7e.png#averageHue=%23ececec&amp;clientId=uc9d64d88-5777-4&amp;from=paste&amp;height=412&amp;id=Sy78w&amp;originHeight=412&amp;originWidth=672&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=68346&amp;status=done&amp;style=none&amp;taskId=u5c4a942b-6651-4675-9709-b648a1a1619&amp;title=&amp;width=672" alt="image.png" loading="lazy"><br><a name="Rrvlq"></a></p><h6 id="_9-5-添加新元素" tabindex="-1"><a class="header-anchor" href="#_9-5-添加新元素" aria-hidden="true">#</a> 9.5：添加新元素</h6><p>新增节点考虑的问题如下：</p><ul><li>哪个需要新增</li><li>新增的该放哪</li></ul><p>问题一在前面设置<code>key</code>的时候就已经解决了，如果新子节点数组内有的而旧的没有的话，说明是新增。<br>问题二其实也简单，因为在新子节点数组里是规定好了顺序，并且也跟对应的真实<code>DOM</code>有联系，所以直接挂载就可以了。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">patchChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> n2<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">04</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">05</span>     <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> n1<span class="token punctuation">.</span>children
<span class="token number">06</span>     <span class="token keyword">const</span> newChildren <span class="token operator">=</span> n2<span class="token punctuation">.</span>children
<span class="token number">07</span>
<span class="token number">08</span>     <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span>
<span class="token number">09</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">10</span>       <span class="token keyword">const</span> newVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token number">11</span>       <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span>
<span class="token number">12</span>       <span class="token comment">// 在第一层循环中定义变量 find，代表是否在旧的一组子节点中找到可复用的节点，</span>
<span class="token number">13</span>       <span class="token comment">// 初始值为 false，代表没找到</span>
<span class="token number">14</span>       <span class="token keyword">let</span> find <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token number">15</span>       <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">16</span>         <span class="token keyword">const</span> oldVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token number">17</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>newVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">18</span>           <span class="token comment">// 一旦找到可复用的节点，则将变量 find 的值设为 true</span>
<span class="token number">19</span>           find <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token number">20</span>           <span class="token function">patch</span><span class="token punctuation">(</span>oldVNode<span class="token punctuation">,</span> newVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">21</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">22</span>             <span class="token keyword">const</span> prevVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token number">23</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>prevVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">24</span>               <span class="token keyword">const</span> anchor <span class="token operator">=</span> prevVNode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling
<span class="token number">25</span>               <span class="token function">insert</span><span class="token punctuation">(</span>newVNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
<span class="token number">26</span>             <span class="token punctuation">}</span>
<span class="token number">27</span>           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">28</span>             lastIndex <span class="token operator">=</span> j
<span class="token number">29</span>           <span class="token punctuation">}</span>
<span class="token number">30</span>           <span class="token keyword">break</span>
<span class="token number">31</span>         <span class="token punctuation">}</span>
<span class="token number">32</span>       <span class="token punctuation">}</span>
<span class="token number">33</span>       <span class="token comment">// 如果代码运行到这里，find 仍然为 false，</span>
<span class="token number">34</span>       <span class="token comment">// 说明当前 newVNode 没有在旧的一组子节点中找到可复用的节点</span>
<span class="token number">35</span>       <span class="token comment">// 也就是说，当前 newVNode 是新增节点，需要挂载</span>
<span class="token number">36</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>find<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">37</span>         <span class="token comment">// 为了将节点挂载到正确位置，我们需要先获取锚点元素</span>
<span class="token number">38</span>         <span class="token comment">// 首先获取当前 newVNode 的前一个 vnode 节点</span>
<span class="token number">39</span>         <span class="token keyword">const</span> prevVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token number">40</span>         <span class="token keyword">let</span> anchor <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token number">41</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>prevVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">42</span>           <span class="token comment">// 如果有前一个 vnode 节点，则使用它的下一个兄弟节点作为锚点元素</span>
<span class="token number">43</span>           anchor <span class="token operator">=</span> prevVNode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling
<span class="token number">44</span>         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">45</span>           <span class="token comment">// 如果没有前一个 vnode 节点，说明即将挂载的新节点是第一个子节点</span>
<span class="token number">46</span>           <span class="token comment">// 这时我们使用容器元素的 firstChild 作为锚点</span>
<span class="token number">47</span>           anchor <span class="token operator">=</span> container<span class="token punctuation">.</span>firstChild
<span class="token number">48</span>         <span class="token punctuation">}</span>
<span class="token number">49</span>         <span class="token comment">// 挂载 newVNode</span>
<span class="token number">50</span>         <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newVNode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
<span class="token number">51</span>       <span class="token punctuation">}</span>
<span class="token number">52</span>     <span class="token punctuation">}</span>
<span class="token number">53</span>
<span class="token number">54</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">55</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">56</span>   <span class="token punctuation">}</span>
<span class="token number">57</span> <span class="token punctuation">}</span>


<span class="token number">01</span> <span class="token comment">// patch 函数需要接收第四个参数，即锚点元素</span>
<span class="token number">02</span> <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>   <span class="token comment">// 省略部分代码</span>
<span class="token number">04</span>
<span class="token number">05</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">06</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">07</span>       <span class="token comment">// 挂载时将锚点元素作为第三个参数传递给 mountElement 函数</span>
<span class="token number">08</span>       <span class="token function">mountElement</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
<span class="token number">09</span>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">10</span>       <span class="token function">patchElement</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span>
<span class="token number">11</span>     <span class="token punctuation">}</span>
<span class="token number">12</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> Text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">13</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">14</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">15</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">16</span>   <span class="token punctuation">}</span>
<span class="token number">17</span> <span class="token punctuation">}</span>
<span class="token number">18</span>
<span class="token number">19</span> <span class="token comment">// mountElement 函数需要增加第三个参数，即锚点元素</span>
<span class="token number">20</span> <span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">21</span>   <span class="token comment">// 省略部分代码</span>
<span class="token number">22</span>
<span class="token number">23</span>   <span class="token comment">// 在插入节点时，将锚点元素透传给 insert 函数</span>
<span class="token number">24</span>   <span class="token function">insert</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
<span class="token number">25</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a name="F71R4"></a></p><h6 id="_9-6-移除不存在的元素" tabindex="-1"><a class="header-anchor" href="#_9-6-移除不存在的元素" aria-hidden="true">#</a> 9.6：移除不存在的元素</h6><p>遍历旧子数组，如果旧的有而新的没有说明要移除。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">patchChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> n2<span class="token punctuation">.</span>children <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">03</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">04</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">05</span>     <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> n1<span class="token punctuation">.</span>children
<span class="token number">06</span>     <span class="token keyword">const</span> newChildren <span class="token operator">=</span> n2<span class="token punctuation">.</span>children
<span class="token number">07</span>
<span class="token number">08</span>     <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span>
<span class="token number">09</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">10</span>       <span class="token comment">// 省略部分代码</span>
<span class="token number">11</span>     <span class="token punctuation">}</span>
<span class="token number">12</span>
<span class="token number">13</span>     <span class="token comment">// 上一步的更新操作完成后</span>
<span class="token number">14</span>     <span class="token comment">// 遍历旧的一组子节点</span>
<span class="token number">15</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">16</span>       <span class="token keyword">const</span> oldVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token number">17</span>       <span class="token comment">// 拿旧子节点 oldVNode 去新的一组子节点中寻找具有相同 key 值的节点</span>
<span class="token number">18</span>       <span class="token keyword">const</span> has <span class="token operator">=</span> newChildren<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
<span class="token number">19</span>         <span class="token parameter">vnode</span> <span class="token operator">=&gt;</span> vnode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVNode<span class="token punctuation">.</span>key
<span class="token number">20</span>       <span class="token punctuation">)</span>
<span class="token number">21</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>has<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">22</span>         <span class="token comment">// 如果没有找到具有相同 key 值的节点，则说明需要删除该节点</span>
<span class="token number">23</span>         <span class="token comment">// 调用 unmount 函数将其卸载</span>
<span class="token number">24</span>         <span class="token function">unmount</span><span class="token punctuation">(</span>oldVNode<span class="token punctuation">)</span>
<span class="token number">25</span>       <span class="token punctuation">}</span>
<span class="token number">26</span>     <span class="token punctuation">}</span>
<span class="token number">27</span>
<span class="token number">28</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">29</span>     <span class="token comment">// 省略部分代码</span>
<span class="token number">30</span>   <span class="token punctuation">}</span>
<span class="token number">31</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a name="AQudu"></a></p><h6 id="_9-7-总结" tabindex="-1"><a class="header-anchor" href="#_9-7-总结" aria-hidden="true">#</a> 9.7：总结</h6><p><code>Diff</code>算法是用来计算两组子节点的差异，并且最大程度上来复用<code>DOM</code>元素。改进前是全部卸载再挂载，改进后是遍历新旧子节点数量，需要更新的更新，需要卸载的卸载，需要增加的增加。其中引入了<code>key</code>，是<code>Diff</code>算法里一个非常重要的角色。<br>然后还讲了如何移动添加删除等等。<br><a name="pQjfQ"></a></p><h5 id="vue设计与实现第十章-双端diff算法" tabindex="-1"><a class="header-anchor" href="#vue设计与实现第十章-双端diff算法" aria-hidden="true">#</a> vue设计与实现第十章：双端Diff算法</h5><p><a name="ZY39g"></a></p><h6 id="_10-1-双端比较的原理" tabindex="-1"><a class="header-anchor" href="#_10-1-双端比较的原理" aria-hidden="true">#</a> 10.1：双端比较的原理</h6><p>简单<code>Diff</code>算法执行流程：<br>遍历<code>newChildren</code>，在<code>oldChildren</code> 里找<code>newChildren[i]</code>的索引，并且维护一个<code>lastIndex</code>记录最大索引</p><ul><li>如果<code>i &lt; lastIndex</code>则将<code>newChildren[i]</code>的真实<code>Dom</code>移动到<code>newChildren[i - 1]</code>下面，</li><li>否则不动，并且更新<code>lastIndex</code></li></ul><p>缺点：如图所示，对于新旧<code>vnode</code>去操作<code>Dom</code>的时候，他是将<code>p-1</code>，<code>p-2</code>往下移。进行了两次操作，假设如果<code>oldVnode</code>是从<code>p1-pn</code>,而<code>newVnode</code>的顺序是<code>pn,p1-pn-1</code>,以简单<code>Diff</code>算法来说，他是不是会进行操作<code>n-1</code>此<code>Dom</code>的移动，但是实际上，只需要将<code>pn</code>移动到最下面，就能完成操作。这就是双端<code>Diff</code>算法 优化的一个方向。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1680918674558-39498fb1-928d-48bd-944e-f21029437c61.png#averageHue=%23f0f0f0&amp;clientId=uea9ba219-d8a1-4&amp;from=paste&amp;height=239&amp;id=u2e74a3d8&amp;originHeight=340&amp;originWidth=390&amp;originalType=binary&amp;ratio=0.8999999761581421&amp;rotation=0&amp;showTitle=false&amp;size=52730&amp;status=done&amp;style=none&amp;taskId=u4ba42473-672d-4b14-aca9-d6319ce3a3f&amp;title=&amp;width=274.31597900390625" alt="image.png" loading="lazy"><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1680918706069-83b7d8fa-c62e-4f8f-8cd2-06ae8e39516d.png#averageHue=%23efefef&amp;clientId=uea9ba219-d8a1-4&amp;from=paste&amp;height=242&amp;id=u255d7fa8&amp;originHeight=290&amp;originWidth=392&amp;originalType=binary&amp;ratio=0.8999999761581421&amp;rotation=0&amp;showTitle=false&amp;size=40267&amp;status=done&amp;style=none&amp;taskId=u1806a264-07ca-4582-989e-de62729c8a1&amp;title=&amp;width=326.5486145019531" alt="image.png" loading="lazy"><br>双端<code>Diff</code>算法执行流程：<br>上面是该算法的变量，下面是该算法每次都要执行的四步</p><ul><li>第一步比较新旧节点的<code>startVnode</code>：对应<code>index</code>往下走</li><li>第二步比较新旧节点的<code>endVnode</code>：对应<code>index</code>往上走</li><li>第三步比较<code>newStartVnode</code>和<code>oldEndVnode</code>：新的往下走，旧的往上走，并且把<code>oldEndVnode</code>插入到<code>oldStartVnode</code>的上面</li><li>第四步比较<code>newEndVnode</code>和<code>oldStartVnode</code>：新的往上走，旧的往下走，并且把<code>oldStartVnode</code>插入到<code>oldEndVnode</code>的下面</li></ul><p>通过比较<code>key</code>值，判断他们是否可复用，如果可复用，则走对应分支，并且更新对应的<code>index</code>。</p><blockquote><p>对于每一个分支，第一步都需要patch</p></blockquote><p><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1680922246786-f8c1107e-beb0-4f41-9827-e605f10ac462.png#averageHue=%23eeeeee&amp;clientId=u16e9008d-eec3-4&amp;from=paste&amp;height=255&amp;id=u1d0fb722&amp;originHeight=191&amp;originWidth=420&amp;originalType=binary&amp;ratio=0.8999999761581421&amp;rotation=0&amp;showTitle=false&amp;size=23009&amp;status=done&amp;style=none&amp;taskId=uaa172edb-3449-4c90-838c-5e4ca60ec8b&amp;title=&amp;width=560" alt="image.png" loading="lazy"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1680922257749-106dc6f5-36fc-452a-b1cb-78ce400960c0.png#averageHue=%23f2f2f2&amp;clientId=u16e9008d-eec3-4&amp;from=paste&amp;height=271&amp;id=uebdb72ca&amp;originHeight=203&amp;originWidth=403&amp;originalType=binary&amp;ratio=0.8999999761581421&amp;rotation=0&amp;showTitle=false&amp;size=24085&amp;status=done&amp;style=none&amp;taskId=ubaea680b-b676-421b-a042-87d3663f6f3&amp;title=&amp;width=537.3333333333334" alt="image.png" loading="lazy"><br>上面是理想状态下的双端<code>Diff</code>算法比较，他能跑起来的前提是，至少有一个分支能走，但是有时候会出现，双端，都走不了的情况，这个时候，他就会走第五步。</p><ul><li>第五步，拿<code>newStartVnode</code>在旧的里面找，找到所在的位置，并且记录为<code>oldToVnode</code>，并且将这个<code>oldToVnode</code>移动到<code>oldStartVnode</code>的上面。</li></ul><blockquote><p>这里暂不考虑没找到的情况，如果没找到，就意味着新增了</p></blockquote><p>此时，就将<code>newStartVode</code>的位置排好了，在而<code>oldToVnode</code>的位置的<code>Vnode</code>是已经走过了的，避免下一次循环再走，所以把它置为<code>undefined</code>，下一轮变量的时候，在加个对<code>oldStartVnode</code>做一下特殊处理，值是<code>undefined</code>直接跳过就好了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1680923258397-c52a2c5f-f28b-4b8e-afbe-5021847f428c.png#averageHue=%23ebebeb&amp;clientId=u16e9008d-eec3-4&amp;from=paste&amp;height=369&amp;id=OkQG2&amp;originHeight=277&amp;originWidth=607&amp;originalType=binary&amp;ratio=0.8999999761581421&amp;rotation=0&amp;showTitle=false&amp;size=42586&amp;status=done&amp;style=none&amp;taskId=u64a76d3b-d6ff-4187-b2bd-7079c69bcdc&amp;title=&amp;width=809.3333333333334" alt="image.png" loading="lazy"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1680923861027-e5f32aea-f0d8-49d1-af0c-f049d210e8b4.png#averageHue=%23ededed&amp;clientId=u16e9008d-eec3-4&amp;from=paste&amp;height=375&amp;id=u6ae871e9&amp;originHeight=281&amp;originWidth=611&amp;originalType=binary&amp;ratio=0.8999999761581421&amp;rotation=0&amp;showTitle=false&amp;size=46302&amp;status=done&amp;style=none&amp;taskId=u24f7425a-59ba-40aa-8e35-0dbdb39e0ca&amp;title=&amp;width=814.6666666666666" alt="image.png" loading="lazy"><br><a name="lrSdt"></a></p><h6 id="_10-2-添加新元素" tabindex="-1"><a class="header-anchor" href="#_10-2-添加新元素" aria-hidden="true">#</a> 10.2：添加新元素</h6><p>对于双端<code>Diff</code>算法的原理，上面分析了该算法如何执行，分析了在理想状态和非理想状态的情况，也就是对于头和尾能不能找到对应的并且移动的情况。<br>在非理想状态下，新旧子数组不能保证他能直接找到，新增分支5用来做特殊处理，以及新增特殊判断，判断该<code>Vnode</code>是否已经移动过了。<br>但是对于非理性状态，也并不是总能找到，这种情况，就属于新增节点。</p><blockquote><p>白话：我新数组里有，你旧的没有，所以新增</p></blockquote><p>逻辑还是挺简单的，就是在分支5中加个判断，如果没有找到重复的<code>key</code>那就将<code>newStartVnoe</code>插入到<code>oldStartVnode</code>的上面即可。<br>但是这还有缺陷，看例子：</p><ul><li><code>newChildren</code>：4，1，2，3</li><li><code>oldChildren</code>：1，2，3</li></ul><p>他们开始跑代码，会发现尾部一直相同，那么就一直会走分支2，然后一直跳过，然后<code>oldEndIndex</code>会变成<code>-1</code>，<code>oldStartIndex</code>还是<code>1</code>，循环结束。但是对于<code>newChildren</code>的<code>4</code>，他并没有做任何操作，被遗弃了。<br>所以，还需要在分支5加个判断，判断<code>newChildren</code>是否有遗留，也就是<code>newStartIndex &lt;= newEndIndex &amp;&amp; oldStartIndex &gt; oldEndIndex</code>，这时候需要将<code>newStartIndex</code>到<code>newEndIndex</code>之间的所有结点挂载到头部。<br><a name="bWKDQ"></a></p><h6 id="_10-3-移除旧节点" tabindex="-1"><a class="header-anchor" href="#_10-3-移除旧节点" aria-hidden="true">#</a> 10.3：移除旧节点</h6><p>判断新增是通过判断<code>oldEnd</code>是否小于<code>oldStart</code>并且满足<code>newStart</code>要小于等于<code>newEnd</code>，而判断移除也差不多，就是判断<code>newEnd</code>是否小于<code>newStart</code>并且满足<code>oldStart</code>要小于等于<code>oldEnd</code>，满足条件就逐个<code>unmount</code>。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token comment">// 省略部分代码 移动节点五个分支</span>
<span class="token number">03</span> <span class="token punctuation">}</span>
<span class="token number">04</span>
<span class="token number">05</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndIdx <span class="token operator">&lt;</span> oldStartIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">06</span>   <span class="token comment">// 添加新节点</span>
<span class="token number">07</span>   <span class="token comment">// 省略部分代码</span>
<span class="token number">08</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndIdx <span class="token operator">&lt;</span> newStartIdx <span class="token operator">&amp;&amp;</span> oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">09</span>   <span class="token comment">// 移除操作</span>
<span class="token number">10</span>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> oldStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">11</span>     <span class="token function">unmount</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token number">12</span>   <span class="token punctuation">}</span>
<span class="token number">13</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a name="HFIWM"></a></p><h5 id="vue设计与实现第十一章-快速diff算法" tabindex="-1"><a class="header-anchor" href="#vue设计与实现第十一章-快速diff算法" aria-hidden="true">#</a> vue设计与实现第十一章：快速Diff算法</h5><p><a name="KyzDc"></a></p><h6 id="_11-1-相同前置和后置元素" tabindex="-1"><a class="header-anchor" href="#_11-1-相同前置和后置元素" aria-hidden="true">#</a> 11.1：相同前置和后置元素</h6><p>快速<code>Diff</code>算法与前两个<code>Diff</code>算法的区别就是它具有一个预处理的过程。<br>何为预处理？本质上来讲就是，晒掉相同的，留下不同的，我只需要去管理不同的部分，并且对该部分进行crud操作。<br>看这边例子：</p><div class="language-latex line-numbers-mode" data-ext="latex"><pre class="language-latex"><code>01 TEXT1: I use vue for app development
02 TEXT2: I use react for app development
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>两段文本，仔细发现其实只有<code>vue</code>和<code>react</code>不一样，前后都一样。那么这说明，真正需要操作的其实只有这两个。</p><div class="language-latex line-numbers-mode" data-ext="latex"><pre class="language-latex"><code>01 TEXT1: I like you
02 TEXT2: I like you too
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这段也一样，只需要处理后面即可。<br>如果引申到<code>vnode</code>上，看如下的图：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1681519758941-c65b946c-0830-4adf-a7d7-02993c6ae6f9.png#averageHue=%23ececec&amp;clientId=u26280add-9a06-4&amp;from=paste&amp;height=613&amp;id=u43cbf890&amp;originHeight=552&amp;originWidth=462&amp;originalType=binary&amp;ratio=0.8999999761581421&amp;rotation=0&amp;showTitle=false&amp;size=56020&amp;status=done&amp;style=none&amp;taskId=ude6c4498-9b8e-4274-8b9c-0ba9c067ab6&amp;title=&amp;width=513.333346932023" alt="image.png" loading="lazy"><br>对于相同的，我们完全不需要去处理它，只需找到不同即可。<br>代码也简单，开两个<code>while</code>循环，然后从顶部和底部遍历掉这些相同节点，将索引去指向需要<code>Diff</code>的区域即可。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">const</span> newChildren <span class="token operator">=</span> n2<span class="token punctuation">.</span>children
<span class="token number">03</span>   <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> n1<span class="token punctuation">.</span>children
<span class="token number">04</span>   <span class="token comment">// 更新相同的前置节点</span>
<span class="token number">05</span>   <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span>
<span class="token number">06</span>   <span class="token keyword">let</span> oldVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token number">07</span>   <span class="token keyword">let</span> newVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token number">08</span>   <span class="token keyword">while</span> <span class="token punctuation">(</span>oldVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">09</span>     <span class="token function">patch</span><span class="token punctuation">(</span>oldVNode<span class="token punctuation">,</span> newVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">10</span>     j<span class="token operator">++</span>
<span class="token number">11</span>     oldVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token number">12</span>     newVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
<span class="token number">13</span>   <span class="token punctuation">}</span>
<span class="token number">14</span>
<span class="token number">15</span>   <span class="token comment">// 更新相同的后置节点</span>
<span class="token number">16</span>   <span class="token comment">// 索引 oldEnd 指向旧的一组子节点的最后一个节点</span>
<span class="token number">17</span>   <span class="token keyword">let</span> oldEnd <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
<span class="token number">18</span>   <span class="token comment">// 索引 newEnd 指向新的一组子节点的最后一个节点</span>
<span class="token number">19</span>   <span class="token keyword">let</span> newEnd <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
<span class="token number">20</span>
<span class="token number">21</span>   oldVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>oldEnd<span class="token punctuation">]</span>
<span class="token number">22</span>   newVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newEnd<span class="token punctuation">]</span>
<span class="token number">23</span>
<span class="token number">24</span>   <span class="token comment">// while 循环从后向前遍历，直到遇到拥有不同 key 值的节点为止</span>
<span class="token number">25</span>   <span class="token keyword">while</span> <span class="token punctuation">(</span>oldVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">26</span>     <span class="token comment">// 调用 patch 函数进行更新</span>
<span class="token number">27</span>     <span class="token function">patch</span><span class="token punctuation">(</span>oldVNode<span class="token punctuation">,</span> newVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
<span class="token number">28</span>     <span class="token comment">// 递减 oldEnd 和 nextEnd</span>
<span class="token number">29</span>     oldEnd<span class="token operator">--</span>
<span class="token number">30</span>     newEnd<span class="token operator">--</span>
<span class="token number">31</span>     oldVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>oldEnd<span class="token punctuation">]</span>
<span class="token number">32</span>     newVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newEnd<span class="token punctuation">]</span>
<span class="token number">33</span>   <span class="token punctuation">}</span>
<span class="token number">34</span>
<span class="token number">35</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1681520079090-84e931d6-251a-41e1-a9b7-fdceeb48688e.png#averageHue=%23f7f7f7&amp;clientId=u26280add-9a06-4&amp;from=paste&amp;height=506&amp;id=u5f8c2ec6&amp;originHeight=455&amp;originWidth=725&amp;originalType=binary&amp;ratio=0.8999999761581421&amp;rotation=0&amp;showTitle=false&amp;size=63929&amp;status=done&amp;style=none&amp;taskId=uffa62bd0-3e2d-459d-b29e-cc7bded5352&amp;title=&amp;width=805.5555768954906" alt="image.png" loading="lazy"><br>这里的新增节点和需要移除的节点跟双端那边类似，只是索引变量名字稍微有点变化。<br><a name="B64bB"></a></p><h6 id="_11-2-判断是否需要进行dom的移动" tabindex="-1"><a class="header-anchor" href="#_11-2-判断是否需要进行dom的移动" aria-hidden="true">#</a> 11.2：判断是否需要进行DOM的移动</h6><p>简明的说，对于以上的预处理以及算法的设计，是在理想状态下的。世间总是不那么尽人意。所以这些节点就是喜欢来给你出问题。比如以下的节点：</p><ul><li><code>newChildren</code>：2 3 1 5 6 4 7 8</li><li><code>oldChildren</code>：2 9 2 5 4 7 2 8</li></ul><p>通过预处理后，只有削去了前面第一个和后面第一个，按照上面算法来跑，说明这之间的又得全部卸载和全部挂在，这明显又回到了原地，不符合快速的这一名称。<br><code>Diff</code>算法，本质上来讲就是想尽可能地减少<code>DOM</code>操作，对于上面的节点，有些还是比较类似的，这说明也还是可以复用，这就回到了如何移动这些可复用的<code>DOM</code>元素上。</p><blockquote><p>不管哪种diff算法，他们终究都需要去做两件事情<br> 1、判断是否需要移动<br> 2、找到需要新增的和需要卸载的</p></blockquote><p>所以，对于非理想情况，应该再开一个分支进行去处理它。<br>算法的设计是建立一个<code>source</code>数组，里面的内容是中间不理想区域的一个索引，也就是对于新节点在旧节点上的索引值。<br>然后通过这个<code>source</code>函数，利用简单<code>Diff</code>算法的思路找出需要移动的节点，也就是序列保持递增时说明不需要移动，反之则需要移动。<br><a name="qhlYP"></a></p><h6 id="_11-3-如何移动" tabindex="-1"><a class="header-anchor" href="#_11-3-如何移动" aria-hidden="true">#</a> 11.3：如何移动</h6><p>基于上面的条件，我们实现了两个目标。</p><ul><li>判断是否需要移动</li><li><code>source</code>数组</li></ul><p>这个<code>source</code>数组可不一般，精髓所在，后续通过它，计算出一个最长递增子序列，然后再去移动<code>Dom</code>。</p><blockquote><p>最长递增子序列：<a href="https://juejin.cn/post/7134499769803603999" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7134499769803603999<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><p>找出最长递增子序列的区间，该区间记录的是在<code>newChildren</code>中这段上升子序列的索引值。构建一个<code>s</code>和<code>i</code>。</p><ul><li><code>s</code>：表示最长递增子序列的尾部索引</li><li><code>i</code>：表示<code>newChildren</code>中预处理后的尾部索引</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2023/png/27119990/1681526855864-91ce30ff-f99c-4cb1-a5bc-cc529b8acff4.png#averageHue=%23f9f9f9&amp;clientId=u26280add-9a06-4&amp;from=paste&amp;height=417&amp;id=u0c958191&amp;originHeight=313&amp;originWidth=529&amp;originalType=binary&amp;ratio=0.8999999761581421&amp;rotation=0&amp;showTitle=false&amp;size=27997&amp;status=done&amp;style=none&amp;taskId=u5ef43c84-93c0-469e-b5e0-276d69b70ee&amp;title=&amp;width=705.3333333333334" alt="image.png" loading="lazy"><br>接着，开始遍历。算法的设计如下：</p><ul><li>如果<code>source[i]</code>的值为<code>-1</code>，这表明该节点需要新增</li><li>如果<code>i！== seq[s]</code>，表明该节点需要移动，直接将该节点移动到他应该所在的位置</li><li>如果前两个分支都没走，说明<code>i === seq[i]</code>的，这是可复用的节点，不需要做任何<code>Dom</code>操作。尾部提升就行。</li></ul><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token number">01</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>moved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">02</span>   <span class="token keyword">const</span> seq <span class="token operator">=</span> <span class="token function">lis</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span>
<span class="token number">03</span>
<span class="token number">04</span>   <span class="token comment">// s 指向最长递增子序列的最后一个元素</span>
<span class="token number">05</span>   <span class="token keyword">let</span> s <span class="token operator">=</span> seq<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
<span class="token number">06</span>   <span class="token keyword">let</span> i <span class="token operator">=</span> count <span class="token operator">-</span> <span class="token number">1</span>
<span class="token number">07</span>   <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">08</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">09</span>       <span class="token comment">// 下面是插入，这里是挂载，位置的获取和下面一样，只是需要特判一下是否是最下面</span>
<span class="token number">10</span>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!==</span> seq<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">11</span>       <span class="token comment">// 说明该节点需要移动</span>
<span class="token number">12</span>       <span class="token comment">// 该节点在新的一组子节点中的真实位置索引</span>
<span class="token number">13</span>       <span class="token keyword">const</span> pos <span class="token operator">=</span> i <span class="token operator">+</span> newStart
<span class="token number">14</span>       <span class="token keyword">const</span> newVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>pos<span class="token punctuation">]</span>
<span class="token number">15</span>       <span class="token comment">// 该节点的下一个节点的位置索引</span>
<span class="token number">16</span>       <span class="token keyword">const</span> nextPos <span class="token operator">=</span> pos <span class="token operator">+</span> <span class="token number">1</span>
<span class="token number">17</span>       <span class="token comment">// 锚点</span>
<span class="token number">18</span>       <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextPos <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length
<span class="token number">19</span>         <span class="token operator">?</span> newChildren<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span><span class="token punctuation">.</span>el
<span class="token number">20</span>         <span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token number">21</span>       <span class="token comment">// 移动</span>
<span class="token number">22</span>       <span class="token function">insert</span><span class="token punctuation">(</span>newVNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
<span class="token number">23</span>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">24</span>       <span class="token comment">// 当 i === seq[s] 时，说明该位置的节点不需要移动</span>
<span class="token number">25</span>       <span class="token comment">// 并让 s 指向下一个位置</span>
<span class="token number">26</span>       s<span class="token operator">--</span>
<span class="token number">27</span>     <span class="token punctuation">}</span>
<span class="token number">28</span>   <span class="token punctuation">}</span>
<span class="token number">29</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a name="UDuYf"></a></p><h6 id="_11-4-总结" tabindex="-1"><a class="header-anchor" href="#_11-4-总结" aria-hidden="true">#</a> 11.4：总结</h6><p>预处理，减少<code>Dom</code>操作，并且还能精确到当前组件。因为快所以叫快速。<br><a name="D5ng1"></a></p><h5 id="vue设计与实现第十二章-组件的实现原理" tabindex="-1"><a class="header-anchor" href="#vue设计与实现第十二章-组件的实现原理" aria-hidden="true">#</a> vue设计与实现第十二章：组件的实现原理</h5></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 2171077189@qq.com">黄院</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a aria-label="内建组件和模块" class="vp-link nav-link prev nav-link prev" href="/blogs/Vue%E6%BA%90%E7%A0%81/%E5%86%85%E5%BB%BA%E7%BB%84%E4%BB%B6%E5%92%8C%E6%A8%A1%E5%9D%97.html"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->内建组件和模块</div></a><a aria-label="服务端渲染" class="vp-link nav-link next nav-link next" href="/blogs/Vue%E6%BA%90%E7%A0%81/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93.html"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">服务端渲染<!----></div></a></nav><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><!----><div class="vp-copyright">Copyright © 2023 Jsweet</div></footer></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/blogs/assets/app-e319b9e5.js" defer></script>
  </body>
</html>
